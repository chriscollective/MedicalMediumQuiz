# 資料清空指南

## 🎯 使用情境

當您需要：
- ✅ 清空所有測驗記錄（準備正式上線）
- ✅ 清空排行榜（重新開始計分）
- ✅ 清空問題回報（已處理完畢）
- ✅ 同時清空多個資料

**不需要：**
- ❌ 重新載入題目（用 `npm run migrate:questions`）
- ❌ 重置管理員密碼（用其他腳本）
- ❌ 完全重置資料庫（用 `npm run restore`）

---

## 🚀 快速開始

執行清空腳本：

```bash
npm run db:clear
```

---

## 📋 互動式操作流程

### **步驟 1：查看可清空的資料**

```
🗑️  可清空的資料
======================================================================
1. 🟡 測驗記錄 (quizzes)
   說明: 所有使用者的測驗記錄
   目前數量: 523 筆

2. 🟡 排行榜 (leaderboards)
   說明: 所有排行榜資料
   目前數量: 187 筆

3. 🟢 問題回報 (reports)
   說明: 使用者回報的問題
   目前數量: 42 筆

======================================================================

🔒 受保護的資料（不可清空）：
   questions, admins, books

======================================================================
```

---

### **步驟 2：選擇要清空的項目**

```
請選擇要清空的項目（可多選）：
輸入格式：數字用逗號分隔，例如 '1,2' 或 '1'
輸入 'all' 清空全部
輸入 'q' 取消

請輸入:
```

**選項：**

| 輸入 | 效果 |
|------|------|
| `1` | 只清空測驗記錄 |
| `2` | 只清空排行榜 |
| `1,2` | 清空測驗記錄 + 排行榜 |
| `all` | 清空所有可清空的資料 |
| `q` | 取消操作 |

---

### **步驟 3：確認清空**

```
⚠️  即將清空以下資料：
======================================================================
   ❌ 測驗記錄: 523 筆
   ❌ 排行榜: 187 筆
======================================================================
   總計: 710 筆資料將被刪除

⚠️  確定要清空嗎？輸入 "DELETE" 確認（大寫）:
```

**必須輸入大寫 `DELETE` 才會執行！**

---

### **步驟 4：執行清空**

```
🔄 開始清空資料...

🗑️  清空 測驗記錄 (quizzes)...
   ✅ 已刪除 523 筆
🗑️  清空 排行榜 (leaderboards)...
   ✅ 已刪除 187 筆

======================================================================
✅ 清空完成！總共刪除 710 筆資料
======================================================================

📊 剩餘資料統計：
======================================================================
🔒 questions: 245 筆 (受保護)
📁 quizzes: 0 筆
📁 leaderboards: 0 筆
🔒 admins: 2 筆 (受保護)
📁 reports: 42 筆
🔒 books: 8 筆 (受保護)
======================================================================

✅ 操作完成！
💡 建議：
   1. 重啟應用程式伺服器
   2. 清除瀏覽器快取
   3. 測試功能是否正常
```

---

## 🎯 常見使用情境

### **情境 1：準備正式上線（清空測試資料）**

**操作：**
```bash
npm run db:clear
```

**輸入：**
```
1,2    # 清空測驗記錄 + 排行榜
DELETE # 確認
```

**效果：**
- ✅ 測驗記錄全部清空（所有測試記錄消失）
- ✅ 排行榜全部清空（重新開始排名）
- ✅ 題目保留（不影響）
- ✅ 管理員帳號保留（不影響）

---

### **情境 2：只重置排行榜（例如每月重置）**

**操作：**
```bash
npm run db:clear
```

**輸入：**
```
2      # 只清空排行榜
DELETE # 確認
```

**效果：**
- ✅ 排行榜清空
- ✅ 測驗記錄保留（歷史資料還在）
- ✅ 可以重新計算排行榜（用 `npm run recalculate:leaderboard`）

---

### **情境 3：清空已處理的問題回報**

**操作：**
```bash
npm run db:clear
```

**輸入：**
```
3      # 只清空問題回報
DELETE # 確認
```

**效果：**
- ✅ 問題回報清空
- ✅ 其他資料不受影響

---

### **情境 4：完全清空所有非重要資料**

**操作：**
```bash
npm run db:clear
```

**輸入：**
```
all    # 清空所有可清空的資料
DELETE # 確認
```

**效果：**
- ✅ 測驗記錄清空
- ✅ 排行榜清空
- ✅ 問題回報清空
- ✅ 題目、管理員、書籍都保留（受保護）

---

## 🔒 安全機制

### **1. 受保護的資料（無法清空）**

以下資料**永遠不會被清空**：

| Collection | 說明 | 原因 |
|-----------|------|------|
| `questions` | 所有題目 | 核心資料，重新導入很麻煩 |
| `admins` | 管理員帳號 | 刪除會導致無法登入 |
| `books` | 書籍資料 | 基礎設定資料 |

---

### **2. 雙重確認機制**

- ✅ 第一次確認：選擇要清空的項目
- ✅ 第二次確認：必須輸入大寫 `DELETE`

**防止誤刪：**
```
❌ delete   → 不會執行
❌ Delete   → 不會執行
✅ DELETE   → 執行清空
```

---

### **3. 操作前顯示統計**

在清空前會顯示：
- 目前數量
- 即將刪除的筆數
- 總計

讓您可以在最後一刻取消。

---

## ⚠️ 注意事項

### **⚠️ 重要：清空前先備份！**

```bash
# 1. 先備份（保險起見）
npm run backup

# 2. 再清空
npm run db:clear

# 3. 如果清空錯了，可以還原
npm run restore
```

---

### **⚠️ 清空後無法復原**

除非有備份，否則清空的資料**永久消失**！

**建議：**
- 每次清空前都先 `npm run backup`
- 特別是在正式環境操作時

---

### **⚠️ 清空後需要重啟伺服器**

```bash
# 清空後重啟
npm run server
```

**原因：**
- 某些資料可能被快取在記憶體中
- 重啟可確保資料一致性

---

## 🆘 常見問題

### **Q1: 誤刪資料怎麼辦？**

**A:** 立即還原最近的備份：
```bash
npm run restore
# 選擇最近的備份
```

---

### **Q2: 可以只清空特定條件的資料嗎？**

**A:** 目前腳本是全部清空。如果需要條件篩選（例如只刪除 30 天前的測驗記錄），需要：

1. 登入 MongoDB Atlas
2. 使用 Query 篩選
3. 或者請我幫您寫一個條件清空腳本

---

### **Q3: 清空排行榜後，測驗記錄還在嗎？**

**A:** 在！

- `quizzes` collection：測驗記錄（完整的測驗資料）
- `leaderboards` collection：排行榜（從 quizzes 中篩選出的高分記錄）

清空排行榜不影響測驗記錄。

如果需要重新計算排行榜：
```bash
npm run recalculate:leaderboard
```

---

### **Q4: 可以清空題目嗎？**

**A:** 不行，題目是受保護的資料。

如果真的需要：
1. 直接到 MongoDB Atlas 手動刪除
2. 或用 `npm run migrate:questions` 重新導入

---

### **Q5: 清空後網站會壞掉嗎？**

**A:** 不會！

- 測驗功能正常（只是沒有歷史記錄）
- 排行榜顯示空白（正常）
- 可以開始新的測驗

---

## 📊 與其他指令的比較

| 指令 | 用途 | 影響範圍 | 可逆性 |
|------|------|---------|--------|
| `npm run db:clear` | 選擇性清空 | 部分資料 | ❌ 不可逆 |
| `npm run restore` | 完全還原 | 全部資料 | ✅ 可逆（如果有備份） |
| `npm run backup` | 備份資料 | 不影響 | ✅ 只讀操作 |
| `npm run db:stats` | 查看統計 | 不影響 | ✅ 只讀操作 |

---

## 💡 最佳實踐

### **正式上線前的清空流程：**

```bash
# 1. 備份測試資料（萬一需要參考）
npm run backup

# 2. 查看統計
npm run db:stats

# 3. 清空測試資料
npm run db:clear
# 輸入: 1,2 (清空測驗記錄 + 排行榜)
# 輸入: DELETE

# 4. 驗證清空結果
npm run db:stats

# 5. 重啟伺服器
npm run server

# 6. 測試網站功能
# - 做一次測驗
# - 查看排行榜
# - 登入後台檢查
```

---

### **每月重置排行榜流程：**

```bash
# 1. 先備份本月資料
npm run backup

# 2. 清空排行榜
npm run db:clear
# 輸入: 2 (只清空排行榜)
# 輸入: DELETE

# 3. 可選：從歷史測驗記錄重新計算排行榜
npm run recalculate:leaderboard

# 4. 重啟伺服器
npm run server
```

---

## 📝 總結

**您現在有：**
- ✅ 選擇性清空腳本（`npm run db:clear`）
- ✅ 安全的雙重確認機制
- ✅ 受保護的重要資料
- ✅ 清空前後的統計顯示

**記得：**
- ⚠️ 清空前先備份
- ⚠️ 必須輸入大寫 `DELETE` 確認
- ⚠️ 清空後重啟伺服器

---

**立即試試看：**
```bash
npm run db:clear
```

選擇 `q` 取消，先熟悉一下介面！ 😉
